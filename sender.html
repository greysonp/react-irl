<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sender - React IRL</title>
    <script src="/socket.io/socket.io.js"></script>

    <style media="screen">
      body, html {
        width: 100%;
        height: 100%;
        text-align: center;
      }

      img {
        display: inline-block;
        width: 100%;
        height: auto;
      }
    </style>

  </head>
  <body>

    <input type="textbox" id="query" value="Search" />
    <input type="button" id="button2" onclick=searchGiphy() value="Search" />
    <div id="container"></div>
    <script>
      var socket = io();

      function sockit(url, width, height) {
        console.log({
          url: url,
          width: width,
          height: height
        });
        socket.emit('send_reaction', {
          url: url,
          width: width,
          height: height
        });
      }
      function searchGiphy() {
        // remove all spans
        var container = document.getElementById('container');
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        var elements = document.getElementsByTagName('span');
        while (elements[0]) elements[0].parentNode.removeChild(elements[0]);

        q = document.getElementById("query").value; // search query

        request = new XMLHttpRequest;
        request.open('GET', 'http://api.giphy.com/v1/gifs/search?api_key=dc6zaTOxFJmzC&limit=10&q='+q, true);

        request.onload = function() {
          if (request.status >= 200 && request.status < 400){
            data = JSON.parse(request.responseText).data;

            // get 5 unique random gifs from response
            var randomNumbers = [];
            while(randomNumbers.length < 5){
              var randomNumber=Math.ceil(Math.random()*(data.length-1))
              var found=false;
              for(var i=0;i<randomNumbers.length;i++){
                if(randomNumbers[i]==randomNumber){ 
                  found=true;
                  break
                }
              }
              if(!found) {
                randomNumbers[randomNumbers.length]=randomNumber;
              }
            }

            var newData = [];
            randomNumbers.forEach(function(number) {
              newData.push(data[number]);
            });
            newData.forEach(function(image) {
              var original = image.images.original;
              console.log(original);

              var imgElement = document.createElement('img');
              imgElement.src = original.url;
              imgElement.onclick = function() {
                sockit(original.url, original.width, original.height);
              }

              document.getElementById('container').appendChild(imgElement);
            });
          } else {
            console.log('reached giphy, but API returned an error');
           }
        };

        request.onerror = function() {
          console.log('connection error');
        };

        request.send();
      }

    </script>
  </body>
</html>
